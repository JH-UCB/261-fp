<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.17.2/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.17.2/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.17.2/dist/index.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"Custom Dataset Preprocessing Pipeline","children":[{"content":"Setup &amp; Configure Environment","children":[{"content":"\n<p data-lines=\"4,5\">Variables &amp; Configuration</p>","children":[{"content":"<code>blob_container</code>, <code>storage_account</code>, <code>secret_scope</code>, <code>secret_key</code>, <code>team_blob_url</code>","children":[],"payload":{"lines":"5,6"}},{"content":"<code>mids261_mount_path</code>","children":[],"payload":{"lines":"6,7"}},{"content":"<code>data_BASE_DIR</code> set to <code>\"dbfs:/mnt/mids-w261/\"</code>","children":[],"payload":{"lines":"7,8"}}],"payload":{"lines":"4,8"}},{"content":"\n<p data-lines=\"8,9\">Spark Configuration</p>","children":[{"content":"Set Azure SAS token for secure Blob Storage access","children":[],"payload":{"lines":"9,10"}}],"payload":{"lines":"8,10"}},{"content":"\n<p data-lines=\"10,11\">Import Libraries &amp; Dependencies</p>","children":[{"content":"<code>pip install timezonefinder</code>","children":[],"payload":{"lines":"11,12"}},{"content":"<code>from timezonefinder import TimezoneFinder</code>","children":[],"payload":{"lines":"12,13"}},{"content":"<code>import pandas as pd</code>","children":[],"payload":{"lines":"13,14"}},{"content":"<code>from pyspark.sql.functions import ...</code>","children":[],"payload":{"lines":"14,15"}},{"content":"<code>from pyspark.sql.types import ...</code>","children":[],"payload":{"lines":"15,17"}}],"payload":{"lines":"10,17"}},{"content":"\n<p data-lines=\"17,18\">Helper Functions</p>","children":[{"content":"<code>calculate_null_counts_and_na_percentage(df, df_name)</code>","children":[{"content":"Computes per-column null counts and NA percentages","children":[{"content":"Function: <code>calculate_null_counts_and_na_percentage(df, df_name)</code>","children":[],"payload":{"lines":"20,21"}},{"content":"Computes <code>null_count</code> and <code>na_percentage</code> for each column.","children":[],"payload":{"lines":"21,23"}}],"payload":{"lines":"19,23"}}],"payload":{"lines":"18,23"}}],"payload":{"lines":"17,23"}},{"content":"\n<p data-lines=\"23,24\">Helper Variables</p>","children":[{"content":"Pipeline Operator Parameters","children":[{"content":"<code>project_phase = \"phase_3\"</code>","children":[],"payload":{"lines":"25,26"}},{"content":"<code>month_run = \"84m\"</code>","children":[],"payload":{"lines":"26,27"}},{"content":"<code>test_or_prod = \"prod\"</code>","children":[],"payload":{"lines":"27,28"}},{"content":"<code>feature_set = \"FS_v1\"</code>","children":[],"payload":{"lines":"28,29"}}],"payload":{"lines":"24,29"}},{"content":"Base directories and file paths derived from these parameters","children":[],"payload":{"lines":"29,31"}}],"payload":{"lines":"23,31"}}],"payload":{"lines":"3,4"}},{"content":"Data Ingestion &amp; Initial Preprocessing","children":[{"content":"Weather Stations (Pre-Processed)","children":[{"content":"Read <code>df_stations</code> from <code>wasbs://.../stations_with_neighbors.parquet</code>","children":[],"payload":{"lines":"33,34"}},{"content":"Original Dimensions: 5,004,169 x 12","children":[],"payload":{"lines":"34,35"}},{"content":"Size: 52.08 MB / 0.05 GB","children":[],"payload":{"lines":"35,36"}},{"content":"Contains station features: <code>neighbor_id</code>, <code>neighbor_call</code>, <code>neighbor_name</code>","children":[],"payload":{"lines":"36,38"}}],"payload":{"lines":"32,33"}},{"content":"Flights Data","children":[{"content":"Read <code>df_flights</code> from <code>dbfs:/mnt/mids-w261/datasets_final_project_2022/parquet_airlines_data/</code>","children":[],"payload":{"lines":"39,40"}},{"content":"Original Dimensions: 74,177,433 x 109","children":[],"payload":{"lines":"40,41"}},{"content":"Flight: 2,804.71 MB / 2.74 GB","children":[],"payload":{"lines":"41,42"}},{"content":"Large dataset of flights from 2015-2021","children":[],"payload":{"lines":"42,43"}},{"content":"Deduplicate 50% of records and drop fully 100% empty columns","children":[],"payload":{"lines":"43,44"}},{"content":"Final Dimensions: 42,430,592 x 93","children":[],"payload":{"lines":"44,46"}}],"payload":{"lines":"38,39"}},{"content":"Weather Data","children":[{"content":"Read <code>df_weather</code> from <code>dbfs:/mnt/mids-w261/datasets_final_project_2022/parquet_weather_data/</code>","children":[],"payload":{"lines":"47,48"}},{"content":"Original Dimensions: 898,983,399 x 124","children":[],"payload":{"lines":"48,49"}},{"content":"Size: 33,423.03 MB / 32.64 GB","children":[],"payload":{"lines":"49,51"}}],"payload":{"lines":"46,47"}},{"content":"Airports Data","children":[{"content":"Read <code>df_airport</code> from <code>wasbs://.../df_airport.parquet</code>","children":[],"payload":{"lines":"52,53"}},{"content":"Original Dimensions: 23,335 x 14","children":[],"payload":{"lines":"53,54"}},{"content":"Size: 5.94 MB / 0.01 GB","children":[],"payload":{"lines":"54,55"}},{"content":"Parse <code>lat</code>/<code>lon</code> from <code>coordinates</code>","children":[],"payload":{"lines":"55,56"}},{"content":"Compute <code>fe_airport_timezone</code> via datetime typecasting and UTC conversion using <code>TimezoneFinder</code>","children":[],"payload":{"lines":"56,58"}}],"payload":{"lines":"51,52"}}],"payload":{"lines":"31,32"}},{"content":"Data Joins","children":[{"content":"\n<p data-lines=\"60,61\">Linking Stations to Airports</p>","children":[{"content":"<code>df_stations</code> joined with <code>df_airport</code>","children":[],"payload":{"lines":"61,62"}},{"content":"Nearest weather station to each airport:","children":[{"content":"Broadcast station list","children":[],"payload":{"lines":"63,64"}},{"content":"Compute haversine distance","children":[],"payload":{"lines":"64,65"}},{"content":"Assign <code>a2w_STATION</code> to each airport","children":[],"payload":{"lines":"65,66"}}],"payload":{"lines":"62,66"}},{"content":"Add <code>fe_airport_timezone</code> to link airports and stations","children":[],"payload":{"lines":"66,68"}}],"payload":{"lines":"60,68"}},{"content":"\n<p data-lines=\"68,69\">Major Join 1: Flights, Airports, and Stations</p>","children":[{"content":"Join <code>df_flights</code> with <code>df_airport</code> (origin/dest)","children":[],"payload":{"lines":"69,70"}},{"content":"Attach corresponding <code>fe_origin_airport_timezone</code> and <code>fe_dest_airport_timezone</code>","children":[],"payload":{"lines":"70,71"}},{"content":"Attach <code>origin_a2w_STATION</code> and <code>dest_a2w_STATION</code> from airports","children":[],"payload":{"lines":"71,72"}},{"content":"Result: <code>df_joined</code>","children":[],"payload":{"lines":"72,74"}}],"payload":{"lines":"68,74"}},{"content":"\n<p data-lines=\"74,75\">Creating Datetime Features in <code>df_joined</code></p>","children":[{"content":"Convert local flight departure/arrival times (from flight date and hhmm format) to timestamps:","children":[{"content":"<code>fe_origin_local_datetime</code>, <code>fe_origin_CRS_local_datetime</code>","children":[],"payload":{"lines":"76,77"}},{"content":"<code>fe_dest_local_datetime</code>, <code>fe_dest_CRS_local_datetime</code>","children":[],"payload":{"lines":"77,78"}}],"payload":{"lines":"75,78"}},{"content":"Convert these local times to UTC using <code>fe_origin_airport_timezone</code> and <code>fe_dest_airport_timezone</code>:","children":[{"content":"<code>fe_origin_UTC_datetime</code>, <code>fe_origin_CRS_UTC_datetime</code>","children":[],"payload":{"lines":"79,80"}},{"content":"<code>fe_dest_UTC_datetime</code>, <code>fe_dest_CRS_UTC_datetime</code>","children":[],"payload":{"lines":"80,82"}}],"payload":{"lines":"78,82"}}],"payload":{"lines":"74,82"}},{"content":"\n<p data-lines=\"82,83\">Major Join 2: Weather Data Subset</p>","children":[{"content":"Filter <code>df_weather</code> to <code>df_weather_subset</code> where <code>STATION</code> matches <code>a2ws_station</code> from flights","children":[],"payload":{"lines":"83,84"}},{"content":"Convert <code>df_weather_subset.DATE</code> to timestamp and then to UTC using origin airportâ€™s timezone","children":[],"payload":{"lines":"84,85"}},{"content":"Join <code>df_joined</code> with <code>df_weather_subset</code>:","children":[{"content":"Match by <code>a2ws_station</code> and time window (2-6 hours before scheduled departure)","children":[],"payload":{"lines":"86,87"}},{"content":"Select most recent weather record per flight","children":[],"payload":{"lines":"87,88"}}],"payload":{"lines":"85,88"}},{"content":"Impute null weather fields with 0 or rolling average (for <code>HourlyDryBulbTemperature</code>)","children":[],"payload":{"lines":"88,90"}}],"payload":{"lines":"82,90"}}],"payload":{"lines":"58,59"}},{"content":"Feature Engineering","children":[{"content":"Handling Delays","children":[{"content":"Filter out canceled flights unless they have <code>DEP_DELAY_NEW &gt;= 15</code>","children":[],"payload":{"lines":"92,93"}},{"content":"Create logged delay features:","children":[{"content":"<code>fe_logged_DEP_DELAY = log(DEP_DELAY+1)</code>","children":[],"payload":{"lines":"94,95"}},{"content":"<code>fe_logged_DEP_DELAY_NEW = log(DEP_DELAY_NEW+1)</code>","children":[],"payload":{"lines":"95,97"}}],"payload":{"lines":"93,97"}}],"payload":{"lines":"91,92"}},{"content":"Holidays","children":[{"content":"For each US holiday in a defined range, create binary holiday proximity features (within Â±1 to +7 days)","children":[{"content":"Example: <code>CHRISTMAS_DAY</code>, <code>NEW_YEARS_DAY</code>, <code>MEMORIAL_DAY</code>, etc.","children":[],"payload":{"lines":"99,101"}}],"payload":{"lines":"98,101"}}],"payload":{"lines":"97,98"}},{"content":"Historical Flight Metrics","children":[{"content":"Compute per-day airline metrics:","children":[{"content":"<code>fe_num_flights_per_day_airline</code>","children":[],"payload":{"lines":"103,104"}},{"content":"<code>fe_avg_DEP_DELAY_per_day_airline</code>","children":[],"payload":{"lines":"104,105"}},{"content":"<code>fe_avg_ARR_DELAY_per_day_airline</code>","children":[],"payload":{"lines":"105,106"}}],"payload":{"lines":"102,106"}},{"content":"Rolling window averages (past 3,7,14,30,60 days) for these metrics:","children":[{"content":"<code>fe_avg_flights_per_day_airline_past_{n}</code>","children":[],"payload":{"lines":"107,108"}},{"content":"<code>fe_avg_DEP_DELAY_per_day_airline_past_{n}</code>","children":[],"payload":{"lines":"108,109"}},{"content":"<code>fe_avg_ARR_DELAY_per_day_airline_past_{n}</code>","children":[],"payload":{"lines":"109,110"}}],"payload":{"lines":"106,110"}},{"content":"Compute per-day origin airport metrics similarly:","children":[{"content":"<code>fe_num_flights_per_day_origin_airport</code>","children":[],"payload":{"lines":"111,112"}},{"content":"<code>fe_avg_DEP_DELAY_per_day_origin_airport</code>","children":[],"payload":{"lines":"112,113"}},{"content":"<code>fe_avg_ARR_DELAY_per_day_origin_airport</code>","children":[],"payload":{"lines":"113,114"}},{"content":"Plus rolling window averages (past 3,7,14,30,60 days)","children":[],"payload":{"lines":"114,116"}}],"payload":{"lines":"110,116"}}],"payload":{"lines":"101,102"}},{"content":"Previous Flight Linking (Same Tail)","children":[{"content":"Using a window partitioned by <code>FL_DATE</code>, <code>OP_CARRIER_AIRLINE_ID</code>, <code>TAIL_NUM</code> ordered by departure UTC:","children":[{"content":"Create <code>fe_flight_of_day</code> (sequence of flights per tail per day)","children":[],"payload":{"lines":"118,119"}},{"content":"Lag features from previous flight on the same tail:","children":[{"content":"<code>fe_prev_flight_DEP_DELAY</code>, <code>fe_prev_flight_ARR_DELAY</code>","children":[],"payload":{"lines":"120,121"}},{"content":"<code>fe_prev_flight_CANCELLED</code>, <code>fe_prev_flight_DISTANCE</code>","children":[],"payload":{"lines":"121,122"}},{"content":"<code>fe_scheduled_layover_time</code> (difference in CRS times)","children":[],"payload":{"lines":"122,123"}},{"content":"<code>fe_time_between_scheduled_departures</code>","children":[],"payload":{"lines":"123,125"}}],"payload":{"lines":"119,125"}}],"payload":{"lines":"117,125"}}],"payload":{"lines":"116,117"}},{"content":"Time Masking of Previous Flight Info","children":[{"content":"If previous flight data is too close (&lt;2 hours), mask actual delays:","children":[{"content":"Replace masked previous delays with historical average delays (<code>fe_avg_DEP_DELAY_per_day_airline_past_3</code>, etc.)","children":[],"payload":{"lines":"127,129"}}],"payload":{"lines":"126,129"}}],"payload":{"lines":"125,126"}},{"content":"Prophet Forecast Features","children":[{"content":"Join prophet-based forecasts (<code>fe_hourly</code>, <code>fe_weekly</code>, <code>fe_month</code>, <code>fe_yhat</code>) based on departure time","children":[],"payload":{"lines":"130,131"}},{"content":"Helps capture demand/seasonality patterns","children":[],"payload":{"lines":"131,133"}}],"payload":{"lines":"129,130"}},{"content":"Graph Feature (PageRank)","children":[{"content":"<code>pagerank</code> feature from pre-computed PageRank on origin airports by year","children":[],"payload":{"lines":"134,136"}}],"payload":{"lines":"133,134"}},{"content":"Data Cleaning and Final Adjustments","children":[{"content":"Drop unused and redundant columns","children":[],"payload":{"lines":"137,138"}},{"content":"Drop records with remaining null fields in crucial features","children":[],"payload":{"lines":"138,139"}},{"content":"Ensure correct final schema for modeling","children":[],"payload":{"lines":"139,141"}}],"payload":{"lines":"136,137"}}],"payload":{"lines":"90,91"}},{"content":"Train/Test Split","children":[{"content":"Split dataset by <code>fe_origin_CRS_UTC_datetime</code>","children":[{"content":"Example: Before 2019-01-01 is train, after is test (depending on <code>month_run</code>)","children":[],"payload":{"lines":"143,144"}}],"payload":{"lines":"142,144"}},{"content":"Create multiple folds within the training set for cross-validation:","children":[{"content":"Generate <code>fold</code> and <code>train_val</code> (train or validation) subsets","children":[],"payload":{"lines":"145,146"}},{"content":"Remove first 2 hours of data in each foldâ€™s training subset to avoid leakage","children":[],"payload":{"lines":"146,147"}}],"payload":{"lines":"144,147"}},{"content":"Partition final train set by <code>fold</code>, <code>train_val</code>, and <code>OP_CARRIER</code> for balanced processing","children":[],"payload":{"lines":"147,149"}}],"payload":{"lines":"141,142"}},{"content":"Outputs","children":[{"content":"Save feature-engineered dataset:","children":[{"content":"Pre-CV full set","children":[],"payload":{"lines":"151,152"}},{"content":"Partitioned train set (folded)","children":[],"payload":{"lines":"152,153"}},{"content":"Test set","children":[],"payload":{"lines":"153,154"}}],"payload":{"lines":"150,154"}}],"payload":{"lines":"149,150"}}],"payload":{"lines":"1,2"}},{"colorFreezeLevel":2,"initialExpandLevel":11})</script>
</body>
</html>
